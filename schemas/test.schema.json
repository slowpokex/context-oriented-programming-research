{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://cop.dev/schema/test-v1.json",
  "title": "COP Test Configuration",
  "description": "Schema for Context-Oriented Programming test definition files",
  "type": "object",
  "required": ["name", "type"],
  "additionalProperties": true,
  "properties": {
    "name": {
      "type": "string",
      "description": "Test suite name",
      "minLength": 1,
      "maxLength": 128
    },
    "type": {
      "type": "string",
      "description": "Type of test suite",
      "enum": ["llm-judged", "adversarial", "deterministic", "comparison"]
    },
    "description": {
      "type": "string",
      "description": "Description of the test suite"
    },
    "judge_model": {
      "type": "string",
      "description": "Model to use for judging (for llm-judged tests)"
    },
    "judge_temperature": {
      "type": "number",
      "description": "Temperature for judge model",
      "minimum": 0,
      "maximum": 2
    },
    "evaluation_criteria": {
      "type": "object",
      "description": "Criteria for evaluating responses",
      "additionalProperties": {
        "$ref": "#/definitions/EvaluationCriterion"
      }
    },
    "test_cases": {
      "type": "array",
      "description": "List of test cases",
      "items": {
        "$ref": "#/definitions/TestCase"
      }
    },
    "passing_threshold": {
      "type": "number",
      "description": "Percentage of tests that must pass (0-1)",
      "minimum": 0,
      "maximum": 1
    },
    "aggregate_minimum": {
      "type": "number",
      "description": "Minimum aggregate score across all criteria",
      "minimum": 0,
      "maximum": 5
    },
    "baseline_version": {
      "type": "string",
      "description": "Version to compare against (for comparison tests)"
    },
    "timeout_seconds": {
      "type": "integer",
      "description": "Timeout for each test case",
      "minimum": 1
    }
  },
  "definitions": {
    "EvaluationCriterion": {
      "type": "object",
      "description": "Criterion for evaluating responses",
      "required": ["weight", "description", "rubric"],
      "additionalProperties": false,
      "properties": {
        "weight": {
          "type": "number",
          "description": "Weight of this criterion in final score",
          "minimum": 0,
          "maximum": 1
        },
        "description": {
          "type": "string",
          "description": "Description of what this criterion measures"
        },
        "rubric": {
          "type": "object",
          "description": "Scoring rubric (1-5 scale)",
          "additionalProperties": {
            "type": "string"
          },
          "propertyNames": {
            "pattern": "^[1-5]$"
          }
        }
      }
    },
    "TestCase": {
      "type": "object",
      "description": "A test case definition",
      "required": ["id", "name", "input"],
      "additionalProperties": true,
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the test case",
          "pattern": "^[a-z][a-z0-9_-]*$"
        },
        "name": {
          "type": "string",
          "description": "Human-readable test name"
        },
        "description": {
          "type": "string",
          "description": "Detailed description of the test"
        },
        "input": {
          "$ref": "#/definitions/TestInput"
        },
        "expected_behaviors": {
          "type": "array",
          "description": "Behaviors the response should exhibit",
          "items": {
            "type": "string"
          }
        },
        "failure_indicators": {
          "type": "array",
          "description": "Indicators that the test has failed",
          "items": {
            "type": "string"
          }
        },
        "minimum_scores": {
          "type": "object",
          "description": "Minimum scores for each criterion",
          "additionalProperties": {
            "type": "number",
            "minimum": 1,
            "maximum": 5
          }
        },
        "expected_output": {
          "description": "Expected output for deterministic tests"
        },
        "expected_output_pattern": {
          "type": "string",
          "description": "Regex pattern for expected output"
        },
        "tags": {
          "type": "array",
          "description": "Tags for categorizing test cases",
          "items": {
            "type": "string"
          }
        },
        "skip": {
          "type": "boolean",
          "description": "Whether to skip this test case"
        },
        "skip_reason": {
          "type": "string",
          "description": "Reason for skipping the test"
        }
      }
    },
    "TestInput": {
      "type": "object",
      "description": "Input for a test case",
      "additionalProperties": true,
      "properties": {
        "customer_message": {
          "type": "string",
          "description": "Customer message for the test"
        },
        "user_message": {
          "type": "string",
          "description": "User message for the test"
        },
        "system_message": {
          "type": "string",
          "description": "System message override"
        },
        "context": {
          "type": "object",
          "description": "Additional context for the test",
          "additionalProperties": true
        },
        "conversation_history": {
          "type": "array",
          "description": "Previous conversation messages",
          "items": {
            "$ref": "#/definitions/Message"
          }
        },
        "variables": {
          "type": "object",
          "description": "Template variables",
          "additionalProperties": true
        }
      }
    },
    "Message": {
      "type": "object",
      "description": "A conversation message",
      "required": ["role", "content"],
      "properties": {
        "role": {
          "type": "string",
          "enum": ["system", "user", "assistant", "function"]
        },
        "content": {
          "type": "string"
        },
        "name": {
          "type": "string"
        }
      }
    }
  }
}
